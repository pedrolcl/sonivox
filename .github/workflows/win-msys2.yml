name: Windows MSYS2 CI

on:
  workflow_dispatch:
  push:
    branches: [ "master", "devel" ]
  pull_request:
    branches: [ "master", "devel" ]

env:
  BUILD_TYPE: RelWithDebInfo
  INSTALL_LOCATION: SonivoxV4
  TEMP: temp

jobs:
  build:
    runs-on: windows-latest
    strategy:
        fail-fast: false
        matrix:
          include:
            - { icon: 'ðŸŸ«', sys: mingw32 }
            - { icon: 'ðŸŸ¦', sys: mingw64 }
            - { icon: 'ðŸŸ¨', sys: ucrt64 }
            - { icon: 'ðŸŸ§', sys: clang64 }

    name: ðŸš§${{ matrix.icon }} msys2 ${{ matrix.sys }}
    defaults:
      run:
        shell: msys2 {0}

    steps:
    - uses: actions/checkout@v4

    - name: '${{ matrix.icon }} Install NSIS'
      uses: repolevedavaj/install-nsis@v1.1.0
      with:
        nsis-version: '3.11'

    - name: '${{ matrix.icon }} Setup MSYS2'
      uses: msys2/setup-msys2@v2
      with:
        release: false
        msystem: ${{matrix.sys}}
        install: >-
          git
          make
        pacboy: >-
          toolchain:p
          cmake:p
          ninja:p
          gtest:p

    - name: '${{ matrix.icon }} TEMP Environment Variable'
      run: |
        mkdir temp

    - name: '${{ matrix.icon }} Downloading a DLS file for testing'
      uses: ethanjli/cached-download-action@6bee1d546f48427140e81ed759b343229c93b7c5
      with:
        url: http://www.ronimusic.com/sf2/Airfont_340.dls
        destination: temp/soundfont.dls
        cache-key: cached.soundfont.dls
        enable-cross-os-archive: true

    - name: '${{ matrix.icon }} Configure CMake'
      run: cmake -B build -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} -DCMAKE_INSTALL_PREFIX=${{env.INSTALL_LOCATION}} -G Ninja -DDEPENDENCY_DIRS= ${{ steps.msys2.outputs.msys2-location }}/bin

    - name: '${{ matrix.icon }} Build'
      run: cmake --build build --config ${{env.BUILD_TYPE}}

    - name: '${{ matrix.icon }} Test'
      working-directory: build
      run: ctest -C ${{env.BUILD_TYPE}} --verbose

    - name: '${{ matrix.icon }} Package'
      run: cmake --build build --target package

    - name: '${{ matrix.icon }} Install'
      run: cmake --install build --config ${{env.BUILD_TYPE}}

    - name: '${{ matrix.icon }} Create Archive'
      run: tar cvf ${{env.INSTALL_LOCATION}}.tar ${{env.INSTALL_LOCATION}}

    - name: '${{ matrix.icon }} Upload Artifacts'
      uses: actions/upload-artifact@v4
      with:
        name: ${{env.INSTALL_LOCATION}}-msys2-${{matrix.sys}}
        path: ${{env.INSTALL_LOCATION}}.tar
        retention-days: 90
        overwrite: true
